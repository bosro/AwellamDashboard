<!-- customer-details.component.html -->
<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center">
        <button 
          routerLink="/customers/list"
          class="mr-4 text-gray-500 hover:text-gray-700">
          <i class="ri-arrow-left-line text-xl"></i>
        </button>
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">
            {{customer?.personalInfo?.firstName}} {{customer?.personalInfo?.lastName}}
          </h1>
          <p class="mt-1 text-sm text-gray-600">
            Customer since {{customer?.accountInfo?.registeredAt | date}}
          </p>
        </div>
      </div>
      <div class="flex space-x-3">
        <button 
          [routerLink]="['/customers/edit', customer?.id]"
          class="flex items-center px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
          <i class="ri-edit-line mr-2"></i>
          Edit
        </button>
        <div class="relative">
          <button 
            (click)="showActions = !showActions"
            class="flex items-center px-4 py-2 bg-white border rounded-lg hover:bg-gray-50">
            Actions
            <i class="ri-arrow-down-s-line ml-2"></i>
          </button>
          <div *ngIf="showActions" 
               class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-10">
            <button 
              (click)="showEmailForm = true"
              class="block w-full px-4 py-2 text-left text-sm hover:bg-gray-100">
              Send Email
            </button>
            <button 
              (click)="showNoteForm = true"
              class="block w-full px-4 py-2 text-left text-sm hover:bg-gray-100">
              Add Note
            </button>
            <div class="border-t my-1"></div>
            <button 
            (click)="updateStatus(CustomerStatus.BLOCKED)"
            class="block w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50">
            Block Customer
          </button>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Content Tabs -->
    <div class="mb-6">
        <nav class="flex space-x-4 border-b">
            <button 
              *ngFor="let tab of tabs"
              (click)="activeTab = tab"
              [ngClass]="{
                'border-b-2 border-blue-600 text-blue-600': activeTab === tab,
                'text-gray-500 hover:text-gray-700': activeTab !== tab
              }"
              class="px-4 py-2 text-sm font-medium"
            >
              {{tab | titlecase}}
            </button>
          </nav>
          
    </div>
  
    <!-- Overview Tab -->
    <div *ngIf="activeTab === 'overview'" class="grid grid-cols-3 gap-6">
      <!-- Customer Info -->
      <div class="col-span-2 space-y-6">
        <!-- Basic Information -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Basic Information</h2>
            <div class="grid grid-cols-2 gap-x-6 gap-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-500">Full Name</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customer?.personalInfo?.firstName}} {{customer?.personalInfo?.lastName}}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Email</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customer?.personalInfo?.email}}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Phone</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customer?.personalInfo?.phone}}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Date of Birth</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customer?.personalInfo?.dateOfBirth | date}}
                </p>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Addresses -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-medium text-gray-900">Addresses</h2>
              <button 
                (click)="showAddAddressForm = true"
                class="text-sm text-blue-600 hover:text-blue-900">
                Add Address
              </button>
            </div>
            <div class="space-y-4">
              <div *ngFor="let address of customer?.addresses"
                   class="border rounded-lg p-4">
                <div class="flex justify-between items-start">
                  <div>
                    <span [ngClass]="{
                      'bg-blue-100 text-blue-800': address.type === 'shipping',
                      'bg-green-100 text-green-800': address.type === 'billing'
                    }" class="px-2 py-1 text-xs font-medium rounded-full">
                      {{address.type}}
                    </span>
                    <span *ngIf="address.isDefault" 
                          class="ml-2 bg-gray-100 text-gray-800 px-2 py-1 text-xs font-medium rounded-full">
                      Default
                    </span>
                  </div>
                  <div class="flex space-x-2">
                    <button 
                      (click)="editAddress(address)"
                      class="text-blue-600 hover:text-blue-900">
                      <i class="ri-edit-line"></i>
                    </button>
                    <button 
                      (click)="deleteAddress(address.id)"
                      class="text-red-600 hover:text-red-900">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </div>
                </div>
                <div class="mt-2">
                  <p class="text-sm text-gray-900">{{address.line1}}</p>
                  <p *ngIf="address.line2" class="text-sm text-gray-900">{{address.line2}}</p>
                  <p class="text-sm text-gray-900">
                    {{address.city}}, {{address.state}} {{address.postalCode}}
                  </p>
                  <p class="text-sm text-gray-900">{{address.country}}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Payment Methods -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-lg font-medium text-gray-900">Payment Methods</h2>
              <button 
                (click)="showAddPaymentForm = true"
                class="text-sm text-blue-600 hover:text-blue-900">
                Add Payment Method
              </button>
            </div>
            <div class="space-y-4">
              <div *ngFor="let payment of customer?.billingInfo?.paymentMethods"
                   class="border rounded-lg p-4">
                <div class="flex justify-between items-start">
                  <div class="flex items-center">
                    <i [class]="getPaymentIcon(payment.type)" class="text-xl mr-3"></i>
                    <div>
                      <p class="text-sm font-medium text-gray-900">
                        {{payment.type | titlecase}} ending in {{payment.lastFour}}
                      </p>
                      <p class="text-sm text-gray-500">
                        Expires {{payment.expiryDate}}
                      </p>
                    </div>
                  </div>
                  <div class="flex space-x-2">
                    <button 
                      *ngIf="!payment.isDefault"
                      (click)="setDefaultPayment(payment.id)"
                      class="text-sm text-blue-600 hover:text-blue-900">
                      Make Default
                    </button>
                    <button 
                      (click)="deletePayment(payment.id)"
                      class="text-red-600 hover:text-red-900">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </div>
                </div>
                <span *ngIf="payment.isDefault" 
                      class="mt-2 inline-block bg-gray-100 text-gray-800 px-2 py-1 text-xs font-medium rounded-full">
                  Default
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Customer Status -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Account Status</h2>
            <div class="space-y-4">
              <div>
                <span [ngClass]="getStatusClass(customer?.accountInfo?.status)"
                      class="px-2 py-1 text-xs font-medium rounded-full">
                  {{customer?.accountInfo?.status}}
                </span>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Customer Type</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customer?.accountInfo?.type | titlecase}}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Last Login</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customer?.accountInfo?.lastLoginAt | date:'medium'}}
                </p>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Customer Metrics -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Metrics</h2>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-500">Lifetime Value</label>
                <p class="mt-1 text-lg font-semibold text-gray-900">
                  ${{customerMetrics.lifetimeValue | number:'1.2-2'}}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Average Order Value</label>
                <p class="mt-1 text-lg font-semibold text-gray-900">
                  ${{customerMetrics.averageOrderValue | number:'1.2-2'}}
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Order Frequency</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customerMetrics.orderFrequency | number:'1.0-0'}} days between orders
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Last Purchase</label>
                <p class="mt-1 text-sm text-gray-900">
                  {{customerMetrics.lastPurchaseDate | date}}
                </p>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Segments -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Segments</h2>
            <div class="space-y-2">
              <div *ngFor="let segment of customer?.segments" 
                   class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm inline-block mr-2">
                {{segment}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Orders Tab -->
    <div *ngIf="activeTab === 'orders'" class="bg-white rounded-lg shadow">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-medium text-gray-900">Order History</h2>
          <button 
            [routerLink]="['/orders/new']"
            [queryParams]="{customerId: customer?.id}"
            class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <i class="ri-add-line mr-2"></i>
            New Order
          </button>
        </div>
        
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order #</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr *ngFor="let order of orders">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">{{order.orderNumber}}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">{{order.createdAt | date:'mediumDate'}}</div>
                  <div class="text-xs text-gray-500">{{order.createdAt | date:'shortTime'}}</div>
                </td>
                <td class="px-6 py-4">
                  <div class="text-sm text-gray-900">{{order.items.length}} items</div>
                  <div class="text-xs text-gray-500">
                    {{order.items[0]?.name}}
                    <span *ngIf="order.items.length > 1">
                      + {{order.items.length - 1}} more
                    </span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${{order.total | number:'1.2-2'}}</div>
                  <div *ngIf="order.discount" class="text-xs text-green-600">
                    -${{order.discount | number:'1.2-2'}} discount
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span [ngClass]="{
                    'bg-yellow-100 text-yellow-800': order.status === 'pending',
                    'bg-blue-100 text-blue-800': order.status === 'processing',
                    'bg-purple-100 text-purple-800': order.status === 'shipped',
                    'bg-green-100 text-green-800': order.status === 'delivered',
                    'bg-red-100 text-red-800': order.status === 'cancelled',
                    'bg-gray-100 text-gray-800': order.status === 'refunded'
                  }" class="px-2 py-1 text-xs font-medium rounded-full">
                    {{order.status}}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <div class="flex justify-end space-x-3">
                    <button 
                      [routerLink]="['/orders/details', order.id]"
                      class="text-blue-600 hover:text-blue-900">
                      <i class="ri-eye-line"></i>
                    </button>
                    <button 
                      [routerLink]="['/orders/edit', order.id]"
                      class="text-blue-600 hover:text-blue-900">
                      <i class="ri-edit-line"></i>
                    </button>
                    <button 
                      *ngIf="order.status === 'pending'"
                      (click)="cancelOrder(order.id)"
                      class="text-red-600 hover:text-red-900">
                      <i class="ri-close-circle-line"></i>
                    </button>
                  </div>
                </td>
              </tr>
          
              <!-- Loading State -->
              <tr *ngIf="loading">
                <td colspan="6" class="px-6 py-4">
                  <div class="flex justify-center">
                    <i class="ri-loader-4-line animate-spin text-blue-600 text-2xl"></i>
                  </div>
                </td>
              </tr>
          
              <!-- No Orders -->
              <tr *ngIf="!loading && orders.length === 0">
                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                  No orders found for this customer
                </td>
              </tr>
            </tbody>
          </table>
      </div>
    </div>
  
 <!-- Communications Tab -->
<div *ngIf="activeTab === 'communications'" class="bg-white rounded-lg shadow">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-900">Communication History</h2>
        <button 
          (click)="showEmailForm = true"
          class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          <i class="ri-mail-send-line mr-2"></i>
          Send Email
        </button>
      </div>
  
      <!-- Communication Preferences -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Communication Preferences</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="flex items-center space-x-2">
            <i [class]="customer?.communicationPreferences?.email ? 'ri-checkbox-circle-fill text-green-500' : 'ri-close-circle-fill text-red-500'"></i>
            <span class="text-sm text-gray-600">Email</span>
          </div>
          <div class="flex items-center space-x-2">
            <i [class]="customer?.communicationPreferences?.sms ? 'ri-checkbox-circle-fill text-green-500' : 'ri-close-circle-fill text-red-500'"></i>
            <span class="text-sm text-gray-600">SMS</span>
          </div>
          <div class="flex items-center space-x-2">
            <i [class]="customer?.communicationPreferences?.phone ? 'ri-checkbox-circle-fill text-green-500' : 'ri-close-circle-fill text-red-500'"></i>
            <span class="text-sm text-gray-600">Phone</span>
          </div>
          <div class="flex items-center space-x-2">
            <i [class]="customer?.communicationPreferences?.marketing ? 'ri-checkbox-circle-fill text-green-500' : 'ri-close-circle-fill text-red-500'"></i>
            <span class="text-sm text-gray-600">Marketing</span>
          </div>
        </div>
      </div>
  
      <!-- Communications List -->
      <div class="flow-root">
        <ul role="list" class="-mb-8">
          <li *ngFor="let comm of communications">
            <div class="relative pb-8">
              <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
              <div class="relative flex items-start space-x-3">
                <div>
                  <div [ngClass]="{
                    'bg-blue-500': comm.type === 'email',
                    'bg-green-500': comm.type === 'sms',
                    'bg-purple-500': comm.type === 'phone',
                    'bg-orange-500': comm.type === 'marketing'
                  }" class="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white">
                    <i [class]="getCommunicationIcon(comm.type)" class="text-white"></i>
                  </div>
                </div>
                <div class="flex-1 min-w-0">
                  <div>
                    <div class="text-sm">
                      <span class="font-medium text-gray-900">{{comm.subject}}</span>
                      <span [ngClass]="{
                        'bg-blue-100 text-blue-800': comm.status === 'sent',
                        'bg-green-100 text-green-800': comm.status === 'delivered',
                        'bg-yellow-100 text-yellow-800': comm.status === 'pending',
                        'bg-red-100 text-red-800': comm.status === 'failed'
                      }" class="ml-2 px-2 py-0.5 text-xs rounded-full">
                        {{comm.status}}
                      </span>
                    </div>
                    <p class="mt-0.5 text-sm text-gray-500">
                      Sent {{comm.date | date:'medium'}}
                    </p>
                  </div>
                  <div class="mt-2 text-sm text-gray-700">
                    <p>{{comm.content}}</p>
                  </div>
                  <div class="mt-2 flex items-center space-x-4">
                    <button 
                      *ngIf="comm.type === 'email'"
                      (click)="resendEmail(comm.id)"
                      class="text-sm text-blue-600 hover:text-blue-900">
                      Resend
                    </button>
                    <button 
                      (click)="viewDetails(comm.id)"
                      class="text-sm text-gray-600 hover:text-gray-900">
                      View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>
  
          <!-- No Communications -->
          <li *ngIf="communications.length === 0">
            <div class="text-center py-8 text-gray-500">
              No communications history found
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
  
  <!-- Notes Tab -->
  <div *ngIf="activeTab === 'notes'" class="bg-white rounded-lg shadow">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-medium text-gray-900">Customer Notes</h2>
        <button 
          (click)="showNoteForm = true"
          class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          <i class="ri-add-line mr-2"></i>
          Add Note
        </button>
      </div>
  
      <!-- Notes List -->
      <div class="flow-root">
        <ul role="list" class="space-y-6">
          <li *ngFor="let note of customer?.metadata?.notes">
            <div class="relative">
              <div [ngClass]="{
                'bg-gray-50': note.type === 'internal',
                'bg-blue-50': note.type === 'customer',
                'bg-yellow-50': note.type === 'system'
              }" class="p-4 rounded-lg">
                <div class="flex justify-between items-start">
                  <div class="flex items-center">
                    <div [ngClass]="{
                      'bg-gray-400': note.type === 'internal',
                      'bg-blue-400': note.type === 'customer',
                      'bg-yellow-400': note.type === 'system'
                    }" class="h-8 w-8 rounded-full flex items-center justify-center">
                      <i [class]="getNoteIcon(note.type)" class="text-white"></i>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm font-medium text-gray-900">
                        {{note.createdBy}}
                      </p>
                      <p class="text-xs text-gray-500">
                        {{note.createdAt | date:'medium'}}
                      </p>
                    </div>
                  </div>
                  <div class="flex space-x-2">
                    <button 
                      (click)="editNote(note)"
                      class="text-gray-400 hover:text-gray-600">
                      <i class="ri-edit-line"></i>
                    </button>
                    <button 
                      (click)="deleteNote(note.id)"
                      class="text-gray-400 hover:text-red-600">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </div>
                </div>
                <div class="mt-3 text-sm text-gray-700">
                  {{note.content}}
                </div>
              </div>
            </div>
          </li>
      
          <li *ngIf="!customer?.metadata?.notes?.length">
            <div class="text-center py-8 text-gray-500">
              No notes found
            </div>
          </li>
        </ul>
      </div>
      
    </div>
  </div>